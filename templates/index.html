<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VeinVision Pro</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
	<link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
	<nav class="navbar navbar-dark bg-dark border-bottom sticky-top">
		<div class="container-fluid">
			<a class="navbar-brand d-flex align-items-center gap-2" href="#">
				<i class="fa-solid fa-eye text-primary"></i>
				<span>VeinVision Pro</span>
				<span class="badge text-bg-danger">LIVE</span>
			</a>
			<div class="d-flex gap-2">
				<button id="darkModeToggle" class="btn btn-outline-light btn-sm" title="Dark / Light"><i class="fas fa-moon"></i></button>
				<button id="suggestPresetBtn" class="btn btn-outline-info btn-sm" title="Suggest Preset"><i class="fas fa-magic"></i></button>
				<button id="fullscreenBtn" class="btn btn-outline-light btn-sm" title="Fullscreen"><i class="fas fa-expand"></i></button>
				<button id="shutdownBtn" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#shutdownModal" title="Shutdown"><i class="fas fa-power-off"></i></button>
			</div>
		</div>
	</nav>

	<main class="container-fluid py-3">
		<div class="row g-3">
			<div class="col-12 col-xl-8">
				<section class="card shadow-sm">
					<div class="card-header d-flex justify-content-between align-items-center">
						<div class="d-flex align-items-center gap-3 small text-muted">
							<span id="exposureInfo">Exp: {{ settings.camera_exposure }}μs</span>
							<span id="gainInfo">Gain: {{ settings.camera_gain }}</span>
							<span id="zoomInfo">Zoom: 1.0x</span>
							<span id="liveInfo">Live: {{ settings.live_processing_method|default('adaptive')|capitalize }} {{ '%.2f'|format(settings.live_downscale|default(0.5)) }}x</span>
							<span id="trackInfo">Trk: Off</span>
						</div>
						<div class="d-flex align-items-center gap-2">
							<button id="captureBtn" class="btn btn-danger btn-sm">
								<i class="fas fa-camera me-1"></i>
								<span id="captureBtnText">Capture</span>
								<span id="captureSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true"></span>
							</button>
							<button id="toggleTrackingBtn" class="btn btn-outline-secondary btn-sm" title="Toggle tracking; click stream to set manual target.">Tracking: Off</button>
							<button id="zoomInBtn" class="btn btn-outline-secondary btn-sm" title="Zoom In (+)"><i class="fas fa-search-plus"></i></button>
							<button id="zoomOutBtn" class="btn btn-outline-secondary btn-sm" title="Zoom Out (-)"><i class="fas fa-search-minus"></i></button>
							<button id="rotateBtn" class="btn btn-outline-secondary btn-sm" title="Rotate (R)"><i class="fas fa-sync-alt"></i></button>
							<button id="resetViewBtn" class="btn btn-outline-secondary btn-sm" title="Reset View"><i class="fas fa-undo"></i></button>
						</div>
					</div>
					<div class="card-body p-0">
						<div class="stream-shell">
							<img id="videoStream" class="stream" src="{{ url_for('video_feed') }}" alt="Live Vein Stream">
						</div>
					</div>
					<div class="card-footer">
						<div class="row g-3 align-items-center">
							<div class="col-md-4">
								<div class="form-check form-check-inline">
									<input class="form-check-input" type="radio" name="liveMethodRadios" id="liveAdaptive" value="adaptive" checked>
									<label class="form-check-label" for="liveAdaptive">Live: Adaptive</label>
								</div>
								<div class="form-check form-check-inline">
									<input class="form-check-input" type="radio" name="liveMethodRadios" id="liveLaplacian" value="laplacian">
									<label class="form-check-label" for="liveLaplacian">Live: Laplacian</label>
								</div>
							</div>
							<div class="col-md-8">
								<div class="row g-2 align-items-center">
									<div class="col">
										<label class="form-label small mb-0">Live scale <span id="liveScaleValue" class="fw-semibold">0.50x</span></label>
										<input id="liveScale" type="range" min="0.25" max="1.0" step="0.05" value="0.5" class="form-range">
									</div>
									<div class="col">
										<label class="form-label small mb-0">Stream FPS <span id="streamFpsValue" class="fw-semibold">{{ settings.stream_target_fps }}</span></label>
										<input id="streamFps" type="range" min="5" max="30" step="1" value="{{ settings.stream_target_fps }}" class="form-range">
									</div>
									<div class="col">
										<label class="form-label small mb-0">JPEG <span id="jpegQualityValue" class="fw-semibold">{{ settings.stream_jpeg_quality }}</span></label>
										<input id="jpegQuality" type="range" min="40" max="95" step="1" value="{{ settings.stream_jpeg_quality }}" class="form-range">
									</div>
									<div class="col-auto d-flex align-items-end">
										<button id="applyLiveSettings" class="btn btn-primary btn-sm">Apply</button>
									</div>
								</div>
							</div>
						</div>
					</div>
				</section>

				<section class="card shadow-sm mt-3">
					<div class="card-header d-flex justify-content-between align-items-center">
						<h6 class="m-0">Last Capture</h6>
						<button id="closeLastCapturedBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-times"></i></button>
					</div>
					<div class="card-body" id="lastCapturedContainer">
						<div class="text-center">
							<img id="lastCapturedImg" class="img-fluid rounded" alt="Last capture">
						</div>
						<div class="d-flex justify-content-between align-items-center mt-2 small">
							<span id="captureTimestamp" class="text-muted">-</span>
							<div class="btn-group btn-group-sm">
								<a id="viewOriginalBtn" target="_blank" class="btn btn-outline-secondary">Original</a>
								<a id="viewProcessedBtn" target="_blank" class="btn btn-outline-secondary">Processed</a>
								<a id="downloadBtn" target="_blank" class="btn btn-success" download><i class="fas fa-download"></i></a>
							</div>
						</div>
					</div>
				</section>
			</div>

			<div class="col-12 col-xl-4">
				<section class="card shadow-sm">
					<div class="card-header"><h6 class="m-0">Image & Camera</h6></div>
					<div class="card-body small">
						<div class="mb-2">
							<label class="form-label">Detection Method</label>
							<select id="detectionMethod" class="form-select form-select-sm">
								<option value="adaptive" {% if settings.detection_method=='adaptive' %}selected{% endif %}>Adaptive</option>
								<option value="frangi" {% if settings.detection_method=='frangi' %}selected{% endif %}>Frangi</option>
								<option value="laplacian" {% if settings.detection_method=='laplacian' %}selected{% endif %}>Laplacian</option>
								<option value="none" {% if settings.detection_method=='none' %}selected{% endif %}>None</option>
							</select>
						</div>
						<div class="row g-2">
							<div class="col-6">
								<label class="form-label">Exposure <span id="exposureValue" class="range-value">{{ settings.camera_exposure }}</span> μs</label>
								<input id="cameraExposure" type="range" class="form-range" min="1000" max="100000" step="1000" value="{{ settings.camera_exposure }}">
							</div>
							<div class="col-6">
								<label class="form-label">Gain <span id="gainValue" class="range-value">{{ settings.camera_gain }}</span></label>
								<input id="cameraGain" type="range" class="form-range" min="1" max="16" step="0.5" value="{{ settings.camera_gain }}">
							</div>
							<div class="col-6">
								<label class="form-label">CLAHE Clip <span id="clipLimitValue" class="range-value">{{ settings.clahe_clip_limit }}</span></label>
								<input id="claheClipLimit" type="range" class="form-range" min="1" max="10" step="0.5" value="{{ settings.clahe_clip_limit }}">
							</div>
							<div class="col-6">
								<label class="form-label">CLAHE Tile <span id="tileSizeValue" class="range-value">{{ settings.clahe_tile_grid_size }}</span></label>
								<input id="claheTileSize" type="range" class="form-range" min="2" max="16" step="2" value="{{ settings.clahe_tile_grid_size }}">
							</div>
							<div class="col-6">
								<label class="form-label">Median ksize <span id="medianValue" class="range-value">{{ settings.median_ksize }}</span></label>
								<input id="medianKsize" type="range" class="form-range" min="1" max="9" step="2" value="{{ settings.median_ksize }}">
							</div>
							<div class="col-6">
								<label class="form-label">Adaptive block <span id="adaptiveBlockValue" class="range-value">{{ settings.adaptive_block_size }}</span></label>
								<input id="adaptiveBlock" type="range" class="form-range" min="11" max="99" step="2" value="{{ settings.adaptive_block_size }}">
							</div>
							<div class="col-6">
								<label class="form-label">Adaptive C <span id="adaptiveCValue" class="range-value">{{ settings.adaptive_C }}</span></label>
								<input id="adaptiveC" type="range" class="form-range" min="-20" max="20" step="1" value="{{ settings.adaptive_C }}">
							</div>
							<div class="col-6">
								<label class="form-label">Morph kernel <span id="morphKernelValue" class="range-value">{{ settings.morph_kernel }}</span></label>
								<input id="morphKernel" type="range" class="form-range" min="1" max="9" step="2" value="{{ settings.morph_kernel }}">
							</div>
							<div class="col-12">
								<label class="form-label">Stream Resolution</label>
								<select id="streamResolution" class="form-select form-select-sm">
									<option value="480p" {% if settings.stream_resolution=='480p' %}selected{% endif %}>480p</option>
									<option value="720p" {% if settings.stream_resolution=='720p' %}selected{% endif %}>720p</option>
									<option value="1080p" {% if settings.stream_resolution=='1080p' %}selected{% endif %}>1080p</option>
								</select>
							</div>
						</div>
						<button id="applyCameraSettings" type="button" class="btn btn-primary w-100 btn-sm mt-2">Apply Settings</button>
					</div>
				</section>

				<section class="card shadow-sm mt-3">
					<div class="card-header"><h6 class="m-0">Profiles</h6></div>
					<div class="card-body small">
						<div class="mb-2">
							<label class="form-label">Saved Profiles</label>
							<div class="input-group input-group-sm">
								<select id="profilesSelect" class="form-select">
									<option value="">Select a profile…</option>
								</select>
								<button id="loadProfileBtn" class="btn btn-primary">Load</button>
							</div>
							<small id="profileDescription" class="text-muted d-block mt-1"></small>
						</div>
						<div class="mb-2">
							<label class="form-label">Save Current as</label>
							<input id="saveProfileName" type="text" class="form-control form-control-sm" placeholder="Profile name">
							<input id="saveProfileDesc" type="text" class="form-control form-control-sm mt-1" placeholder="Optional description">
							<div class="d-grid gap-2 mt-2">
								<button id="saveProfileBtn" class="btn btn-outline-primary btn-sm"><i class="fas fa-save me-1"></i>Save Profile</button>
							</div>
						</div>
					</div>
				</section>

				<section class="card shadow-sm mt-3">
					<div class="card-header"><h6 class="m-0">LEDs</h6></div>
					<div class="card-body small">
						<label class="form-label">Brightness <span id="brightnessValue" class="range-value">{{ settings.led_brightness }}</span></label>
						<input id="ledBrightness" type="range" class="form-range" min="0" max="255" value="{{ settings.led_brightness }}">
						<div class="mt-2">
							<label class="form-label">Pattern</label>
							<select id="ledPattern" class="form-select form-select-sm">
								<option value="1" {% if settings.led_pattern==1 %}selected{% endif %}>All On</option>
								<option value="2" {% if settings.led_pattern==2 %}selected{% endif %}>Alternate</option>
								<option value="3" {% if settings.led_pattern==3 %}selected{% endif %}>Sequential</option>
							</select>
						</div>
						<div class="d-grid gap-2 mt-3">
							<button id="toggleLEDs" class="btn btn-outline-primary btn-sm"><i class="fas fa-power-off me-1"></i>Toggle</button>
							<button id="applyLEDSettings" class="btn btn-primary btn-sm"><i class="fas fa-save me-1"></i>Apply</button>
						</div>
					</div>
				</section>

				<section class="card shadow-sm mt-3">
					<div class="card-header"><h6 class="m-0">Patient & Notes</h6></div>
					<div class="card-body small">
						<form id="patientForm" class="mb-3">
							<div class="row g-2">
								<div class="col-6"><input id="patientName" type="text" class="form-control form-control-sm" placeholder="Name"></div>
								<div class="col-6"><input id="patientId" type="text" class="form-control form-control-sm" placeholder="ID"></div>
								<div class="col-6"><input id="patientAge" type="number" class="form-control form-control-sm" placeholder="Age"></div>
								<div class="col-6">
									<select id="procedureType" class="form-select form-select-sm">
										<option value="">Procedure</option>
										<option value="venipuncture">Venipuncture</option>
										<option value="iv">IV Placement</option>
										<option value="injection">Injection</option>
										<option value="other">Other</option>
									</select>
								</div>
							</div>
							<button type="submit" class="btn btn-primary w-100 btn-sm mt-2">Save Patient</button>
						</form>
						<div>
							<label class="form-label">Procedure Notes</label>
							<textarea id="procedureNotes" class="form-control form-control-sm mb-2" rows="3" placeholder="Enter notes..."></textarea>
							<div class="d-flex gap-2">
								<button id="saveNotesBtn" class="btn btn-primary btn-sm"><i class="fas fa-save me-1"></i>Save</button>
								<button id="clearNotesBtn" class="btn btn-outline-secondary btn-sm"><i class="fas fa-eraser me-1"></i>Clear</button>
							</div>
						</div>
					</div>
				</section>
			</div>
		</div>

		<section class="card shadow-sm mt-3">
			<div class="card-header d-flex justify-content-between align-items-center">
				<h6 class="m-0">Image Gallery</h6>
				<div class="d-flex gap-2">
					<div class="input-group input-group-sm" style="max-width:240px;">
						<input id="gallerySearch" type="text" class="form-control" placeholder="Search...">
						<button id="gallerySearchBtn" class="btn btn-outline-secondary"><i class="fas fa-search"></i></button>
					</div>
					<select id="galleryPageSize" class="form-select form-select-sm w-auto">
						<option value="12">12</option><option value="24">24</option><option value="48">48</option>
					</select>
					<button id="refreshGalleryBtn" class="btn btn-outline-primary btn-sm" title="Refresh"><i class="fas fa-sync-alt"></i></button>
					<button id="clearGalleryBtn" class="btn btn-outline-danger btn-sm" title="Clear All"><i class="fas fa-trash"></i></button>
				</div>
			</div>
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center mb-2 small">
					<div id="paginationInfo">Page 1/1</div>
					<div class="btn-group btn-group-sm">
						<button id="paginationPrev" class="btn btn-outline-secondary"><i class="fas fa-chevron-left"></i></button>
						<button id="paginationNext" class="btn btn-outline-secondary"><i class="fas fa-chevron-right"></i></button>
					</div>
				</div>
				<div id="imageGallery" class="row g-2">
					<div class="col-12 text-center py-4">
						<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
						<p class="small text-muted mb-0 mt-2">Loading images...</p>
					</div>
				</div>
			</div>
		</section>

		<footer class="d-flex flex-wrap justify-content-between align-items-center mt-4 small text-muted">
			<span id="lanUrl">Resolving LAN...</span>
			<span>VeinVision Pro</span>
		</footer>
	</main>

	<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

	<div class="modal fade" id="shutdownModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header bg-danger text-white"><h5 class="modal-title">Shutdown System</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
				<div class="modal-body text-center"><i class="fas fa-power-off fa-3x text-danger mb-3"></i><p>Safely power off camera & LED controller?</p></div>
				<div class="modal-footer"><button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button><button id="confirmShutdown" class="btn btn-danger btn-sm"><i class="fas fa-power-off me-1"></i>Confirm</button></div>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script src="{{ url_for('static', filename='app.js') }}"></script>
	<script>
		fetch('/local_domain').then(r=>r.json()).then(d=>{if(d.success&&d.urls&&d.urls.length){document.getElementById('lanUrl').textContent=d.urls[0];}}).catch(()=>{});
	</script>
</body>
</html>
