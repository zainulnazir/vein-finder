<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeinVision Pro - Medical Imaging System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <style>
        :root {
            --primary: #0d6efd;
            --secondary: #6c757d;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #0dcaf0;
        }

        body {
            padding-top: 20px;
            padding-bottom: 20px;
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .app-header {
            background: linear-gradient(135deg, #052c65, #0d6efd);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .video-stream {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* This ensures the video maintains its aspect ratio */
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .camera-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .settings-card {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .settings-header {
            background: linear-gradient(to right, #0d6efd, #0a58ca);
            color: white;
            padding: 15px;
            font-weight: 600;
        }

        .settings-body {
            background-color: #f8f9fa;
            padding: 15px;
        }

        .gallery-container {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .gallery-image {
            cursor: pointer;
            transition: transform 0.3s ease;
            max-height: 180px;
            width: auto;
            max-width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            display: block;
        }

        .gallery-image:hover {
            transform: scale(1.03);
        }

        .image-card {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .image-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }

        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background-color: rgba(13, 110, 253, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .patient-info {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .notes-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .system-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .system-control .btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .highlight {
            animation: highlight 2s;
        }

        @keyframes highlight {
            0% {
                background-color: #fffacd;
            }

            100% {
                background-color: transparent;
            }
        }

        /* Dark mode styles */
        .dark-mode {
            background-color: #212529;
            color: #f8f9fa;
        }

        .dark-mode .main-container {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark-mode .settings-body {
            background-color: #495057;
            color: #f8f9fa;
        }

        .dark-mode .gallery-container {
            background-color: #343a40;
        }

        .dark-mode .stat-card {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark-mode .form-control,
        .dark-mode .form-select {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }

        .dark-mode .modal-content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark-mode .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- App Header -->
        <div class="app-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="fas fa-eye me-2"></i>VeinVision Pro</h1>
                    <p class="mb-0">Advanced Medical Imaging System for Venipuncture Assistance</p>
                </div>
                <div class="col-md-6 d-flex justify-content-end">
                    <div class="btn-group">
                        <button id="darkModeToggle" class="btn btn-outline-light">
                            <i class="fas fa-moon me-2"></i>Dark Mode
                        </button>
                        <button id="settingsBtn" class="btn btn-outline-light" data-bs-toggle="modal"
                            data-bs-target="#settingsModal">
                            <i class="fas fa-cog me-2"></i>Settings
                        </button>
                        <button id="shutdownBtn" class="btn btn-outline-light" data-bs-toggle="modal"
                            data-bs-target="#shutdownModal">
                            <i class="fas fa-power-off me-2"></i>Power
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Stats -->
        <div class="system-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <div>
                    <div class="small text-muted">Images Captured</div>
                    <div class="fs-4 fw-bold" id="captureCounter">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(25, 135, 84, 0.1); color: var(--success);">
                    <i class="fas fa-lightbulb"></i>
                </div>
                <div>
                    <div class="small text-muted">LED Status</div>
                    <div class="fs-4 fw-bold" id="ledStatus">Active</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(13, 202, 240, 0.1); color: var(--info);">
                    <i class="fas fa-microchip"></i>
                </div>
                <div>
                    <div class="small text-muted">System Status</div>
                    <div class="fs-4 fw-bold" id="systemStatus">Online</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background-color: rgba(220, 53, 69, 0.1); color: var(--danger);">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <div>
                    <div class="small text-muted">Detection Method</div>
                    <div class="fs-4 fw-bold" id="detectionMethodDisplay">{{ settings.detection_method }}</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-container">
            <div class="row">
                <!-- Video Feed and Image Capture Section -->
                <div class="col-md-8">
                    <div class="video-container mb-3">
                        <div class="camera-info">
                            <i class="fas fa-circle text-danger me-1"></i> LIVE
                            <span class="ms-2" id="exposureInfo">Exp: {{ settings.camera_exposure }}μs</span>
                            <span class="ms-2" id="gainInfo">Gain: {{ settings.camera_gain }}</span>
                        </div>
                        <img src="{{ url_for('video_feed') }}" class="video-stream">
                        <div class="video-controls">
                            <button id="captureBtn" class="btn btn-danger">
                                <i class="fas fa-camera me-2"></i><span id="captureBtnText">Capture</span>
                                <span id="captureSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                                    aria-hidden="true"></span>
                            </button>
                            <button id="zoomInBtn" class="btn btn-light">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button id="zoomOutBtn" class="btn btn-light">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button id="rotateBtn" class="btn btn-light">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="fullscreenBtn" class="btn btn-light">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Last Captured Image -->
                    <div id="lastCapturedContainer" class="mb-3 d-none">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Last Captured Image</h5>
                            </div>
                            <div class="card-body text-center">
                                <img id="lastCapturedImg" class="img-fluid"
                                    style="max-height: 200px; width: auto; object-fit: contain;">
                            </div>
                        </div>
                    </div>

                    <!-- Captured Image Info -->
                    <div class="alert alert-success d-none" id="capturedImageInfo">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Image Captured Successfully
                                </h5>
                                <p class="mb-0">Timestamp: <span id="captureTimestamp"></span></p>
                            </div>
                            <div class="btn-group">
                                <a href="#" id="viewOriginalBtn" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-eye me-1"></i>View Original
                                </a>
                                <a href="#" id="viewProcessedBtn" class="btn btn-sm btn-success">
                                    <i class="fas fa-eye me-1"></i>View Processed
                                </a>
                                <a href="#" id="downloadBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="notes-section">
                        <h5><i class="fas fa-sticky-note me-2"></i>Procedure Notes</h5>
                        <div class="mb-3">
                            <textarea class="form-control" id="procedureNotes" rows="3"
                                placeholder="Enter notes about the procedure, vein condition, etc."></textarea>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button id="saveNotesBtn" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Notes
                            </button>
                            <button id="clearNotesBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-eraser me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Patient Info Section -->
                <div class="col-md-4">
                    <!-- Settings Panel -->
                    <div class="settings-card">
                        <div class="settings-header">
                            <i class="fas fa-sliders-h me-2"></i>Image Settings
                        </div>
                        <div class="settings-body">
                            <form id="settingsForm">
                                <div class="mb-3">
                                    <label for="detectionMethod" class="form-label">Vein Detection Method</label>
                                    <select id="detectionMethod" class="form-select">
                                        <option value="adaptive" {% if settings.detection_method=='adaptive'
                                            %}selected{% endif %}>Adaptive Threshold</option>
                                        <option value="frangi" {% if settings.detection_method=='frangi' %}selected{%
                                            endif %}>Frangi Filter</option>
                                        <option value="laplacian" {% if settings.detection_method=='laplacian'
                                            %}selected{% endif %}>Laplacian</option>
                                        <option value="thermal" {% if settings.detection_method=='thermal' %}selected{%
                                            endif %}>Thermal</option>
                                        <option value="none" {% if settings.detection_method=='none' %}selected{% endif
                                            %}>None (Raw)</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="contrastMethod" class="form-label">Contrast Enhancement</label>
                                    <select id="contrastMethod" class="form-select">
                                        <option value="clahe" {% if settings.contrast_method=='clahe' %}selected{% endif
                                            %}>CLAHE</option>
                                        <option value="histogram_equalization" {% if
                                            settings.contrast_method=='histogram_equalization' %}selected{% endif %}>
                                            Histogram Equalization</option>
                                        <option value="none" {% if settings.contrast_method=='none' %}selected{% endif
                                            %}>None</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="cameraExposure" class="form-label">Exposure Time (μs): <span
                                            id="exposureValue">{{ settings.camera_exposure }}</span></label>
                                    <input type="range" class="form-range" id="cameraExposure" min="1000" max="100000"
                                        step="1000" value="{{ settings.camera_exposure }}">
                                </div>

                                <div class="mb-3">
                                    <label for="cameraGain" class="form-label">Camera Gain: <span id="gainValue">{{
                                            settings.camera_gain }}</span></label>
                                    <input type="range" class="form-range" id="cameraGain" min="1" max="16" step="0.5"
                                        value="{{ settings.camera_gain }}">
                                </div>

                                <div class="mb-3">
                                    <label for="streamResolution" class="form-label">Stream Resolution</label>
                                    <select id="streamResolution" class="form-select">
                                        <option value="480p" {% if settings.stream_resolution=='480p' %}selected{% endif
                                            %}>480p (Fast)</option>
                                        <option value="720p" {% if settings.stream_resolution=='720p' %}selected{% endif
                                            %}>720p (Balanced)</option>
                                        <option value="1080p" {% if settings.stream_resolution=='1080p' %}selected{%
                                            endif %}>1080p (High Detail)</option>
                                    </select>
                                    <small class="form-text text-muted">Note: All captures are always done in high
                                        resolution.</small>
                                </div>

                                <button id="applyCameraSettings" type="submit" class="btn btn-primary w-100">Apply
                                    Settings</button>
                            </form>
                        </div>
                    </div>

                    <!-- LED Controls -->
                    <div class="settings-card mt-3">
                        <div class="settings-header">
                            <i class="fas fa-lightbulb me-2"></i>LED Controls
                        </div>
                        <div class="settings-body">
                            <div class="mb-3">
                                <label for="ledBrightness" class="form-label">LED Brightness: <span
                                        id="brightnessValue">{{ settings.led_brightness }}</span></label>
                                <input type="range" class="form-range" id="ledBrightness" min="0" max="255"
                                    value="{{ settings.led_brightness }}">
                            </div>

                            <div class="mb-3">
                                <label for="ledPattern" class="form-label">LED Pattern</label>
                                <select id="ledPattern" class="form-select">
                                    <option value="1" {% if settings.led_pattern==1 %}selected{% endif %}>All On
                                    </option>
                                    <option value="2" {% if settings.led_pattern==2 %}selected{% endif %}>Alternate
                                    </option>
                                    <option value="3" {% if settings.led_pattern==3 %}selected{% endif %}>Sequential
                                    </option>
                                </select>
                            </div>

                            <div class="d-grid gap-2">
                                <button id="toggleLEDs" class="btn btn-primary">
                                    <i class="fas fa-power-off me-2"></i>Toggle LEDs
                                </button>
                                <button id="applyLEDSettings" class="btn btn-outline-primary">
                                    <i class="fas fa-save me-2"></i>Apply LED Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    <div class="settings-card mt-3">
                        <div class="settings-header">
                            <i class="fas fa-user-md me-2"></i>Patient Information
                        </div>
                        <div class="settings-body">
                            <form id="patientForm">
                                <div class="mb-3">
                                    <label for="patientName" class="form-label">Patient Name</label>
                                    <input type="text" class="form-control" id="patientName"
                                        placeholder="Enter patient name">
                                </div>
                                <div class="mb-3">
                                    <label for="patientAge" class="form-label">Age</label>
                                    <input type="number" class="form-control" id="patientAge" placeholder="Enter age">
                                </div>
                                <div class="mb-3">
                                    <label for="procedureType" class="form-label">Procedure</label>
                                    <select class="form-select" id="procedureType">
                                        <option value="">Select procedure</option>
                                        <option value="venipuncture">Venipuncture</option>
                                        <option value="iv">IV Placement</option>
                                        <option value="injection">Injection</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Save Patient Info</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Gallery -->
        <div class="gallery-container" id="gallery">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-images me-2"></i>Image Gallery</h3>
                <div class="btn-group">
                    <button id="refreshGalleryBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <button id="clearGalleryBtn" class="btn btn-outline-danger">
                        <i class="fas fa-trash me-2"></i>Clear All
                    </button>
                </div>
            </div>

            <div class="row" id="imageGallery">
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading saved images...</p>
                </div>
            </div>
        </div>

        <footer class="text-center text-muted mt-4">
            <p>VeinVision Pro | Advanced Medical Imaging System for Venipuncture Assistance</p>
            <p class="small">System Version 1.0 | <a href="#" data-bs-toggle="modal"
                    data-bs-target="#aboutModal">About</a></p>
        </footer>
    </div>

    <!-- System Control Buttons -->
    <div class="system-control">
        <button class="btn btn-primary" title="Help" data-bs-toggle="modal" data-bs-target="#helpModal">
            <i class="fas fa-question"></i>
        </button>
        <button class="btn btn-success" title="System Info" data-bs-toggle="modal" data-bs-target="#systemInfoModal">
            <i class="fas fa-info"></i>
        </button>
        <button class="btn btn-danger" title="Shutdown" data-bs-toggle="modal" data-bs-target="#shutdownModal">
            <i class="fas fa-power-off"></i>
        </button>
    </div>

    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel">About VeinVision Pro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-eye fa-4x text-primary mb-3"></i>
                        <h4>VeinVision Pro v1.0</h4>
                        <p class="text-muted">Advanced Medical Imaging System for Venipuncture Assistance</p>
                    </div>

                    <div class="mb-4">
                        <h5>Description</h5>
                        <p>VeinVision Pro uses infrared technology and advanced image processing algorithms to enhance
                            the visibility of veins beneath the skin, making venipuncture procedures easier and more
                            accurate.</p>
                    </div>

                    <div class="mb-4">
                        <h5>Hardware</h5>
                        <ul>
                            <li>Raspberry Pi 4B</li>
                            <li>Raspberry Pi NoIR Camera v2</li>
                            <li>8 IR LEDs (850nm wavelength)</li>
                            <li>Arduino-controlled LED array</li>
                        </ul>
                    </div>

                    <div>
                        <h5>Algorithms</h5>
                        <ul>
                            <li>Adaptive Threshold: Best for general use</li>
                            <li>Frangi Filter: Optimized for thin veins</li>
                            <li>Laplacian: Good for high contrast</li>
                            <li>Thermal Visualization: Heat map visualization</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">VeinVision Pro Help</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="accordion" id="helpAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    Getting Started
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>To start using VeinVision Pro:</p>
                                    <ol>
                                        <li>Ensure the system is properly powered and connected</li>
                                        <li>Position the device 10-15cm from the patient's skin</li>
                                        <li>Adjust the camera exposure and gain settings for optimal vein visibility
                                        </li>
                                        <li>Select a detection algorithm appropriate for the patient's skin type</li>
                                        <li>Use the zoom and rotate functions as needed to get a better view</li>
                                        <li>Capture and save images for documentation</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Camera Controls
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <h6>Exposure Setting</h6>
                                    <p>Controls the amount of light captured. Higher values (20,000-50,000μs) are better
                                        for darker environments.</p>

                                    <h6>Gain Setting</h6>
                                    <p>Amplifies the signal. Higher values (8-16) improve visibility in low light but
                                        may introduce noise.</p>

                                    <h6>Detection Methods</h6>
                                    <ul>
                                        <li><strong>Adaptive Threshold:</strong> Best for general use and medium skin
                                            tones</li>
                                        <li><strong>Frangi Filter:</strong> Best for visualizing fine vein structures
                                        </li>
                                        <li><strong>Laplacian:</strong> Good for highlighting edges of veins</li>
                                        <li><strong>Thermal:</strong> Provides a heat-map style visualization</li>
                                    </ul>

                                    <h6>Image Controls</h6>
                                    <ul>
                                        <li>Zoom: Enlarge the image up to 3x</li>
                                        <li>Rotate: Rotate the image in 90° increments</li>
                                        <li>Fullscreen: Expand the video to fullscreen</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                    LED Controls
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                                data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>The IR LEDs help illuminate veins beneath the skin. You can control:</p>
                                    <ul>
                                        <li><strong>Brightness:</strong> Adjust from 0-255. Higher values provide better
                                            illumination but may wash out the image.</li>
                                        <li><strong>Pattern:</strong>
                                            <ul>
                                                <li>All On: Maximum illumination</li>
                                                <li>Alternate: Every other LED is on, creates more shadows</li>
                                                <li>Sequential: LEDs light up in sequence, helps identify depth</li>
                                            </ul>
                                        </li>
                                        <li><strong>Toggle:</strong> Quickly turn LEDs on/off to compare visibility</li>
                                    </ul>
                                    <p><em>Note: The LEDs are infrared (850nm) and not visible to the naked eye.</em>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                    Patient Information & Notes
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour"
                                data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <p>You can record patient information and procedural notes:</p>
                                    <ul>
                                        <li>Enter patient name, age, and procedure type</li>
                                        <li>Add detailed notes about the procedure</li>
                                        <li>This information is stored with captured images</li>
                                        <li>Patient data is stored locally for privacy</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFive">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                                    Troubleshooting
                                </button>
                            </h2>
                            <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive"
                                data-bs-parent="#helpAccordion">
                                <div class="accordion-body">
                                    <h6>No Camera Feed</h6>
                                    <ul>
                                        <li>Check if system is running in simulation mode</li>
                                        <li>Ensure camera connection is secure</li>
                                        <li>Restart the application</li>
                                    </ul>

                                    <h6>LED Not Working</h6>
                                    <ul>
                                        <li>Check Arduino connection</li>
                                        <li>Verify brightness setting is not at zero</li>
                                        <li>Try different LED pattern</li>
                                    </ul>

                                    <h6>Poor Image Quality</h6>
                                    <ul>
                                        <li>Adjust camera exposure and gain</li>
                                        <li>Try different detection methods</li>
                                        <li>Ensure adequate ambient lighting (dim but not dark)</li>
                                        <li>Position camera 10-15cm from skin surface</li>
                                    </ul>

                                    <h6>System Crash or Freeze</h6>
                                    <ul>
                                        <li>Use the shutdown button to properly close the application</li>
                                        <li>Restart the device if necessary</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Info Modal -->
    <div class="modal fade" id="systemInfoModal" tabindex="-1" aria-labelledby="systemInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="systemInfoModalLabel">System Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Camera</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th scope="row">Model</th>
                                    <td id="cameraModel">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Resolution</th>
                                    <td id="cameraResolution">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Frame Rate</th>
                                    <td id="cameraFrameRate">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Mode</th>
                                    <td id="cameraMode">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mb-4">
                        <h6>LED Controller</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th scope="row">Status</th>
                                    <td id="ledControllerStatus">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Port</th>
                                    <td id="ledControllerPort">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Brightness</th>
                                    <td id="ledBrightnessInfo">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Pattern</th>
                                    <td id="ledPatternInfo">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div>
                        <h6>Storage</h6>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th scope="row">Images Saved</th>
                                    <td id="imageCount">Loading...</td>
                                </tr>
                                <tr>
                                    <th scope="row">Last Capture</th>
                                    <td id="lastCapture">None</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shutdown Modal -->
    <div class="modal fade" id="shutdownModal" tabindex="-1" aria-labelledby="shutdownModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="shutdownModalLabel">Shutdown System</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-power-off fa-4x text-danger mb-3"></i>
                        <h5>Are you sure you want to shut down?</h5>
                        <p class="text-muted">This will safely turn off the camera and LED controller.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button id="confirmShutdown" type="button" class="btn btn-danger">
                        <i class="fas fa-power-off me-2"></i>Confirm Shutdown
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Captured Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" class="img-fluid modal-image" alt="Captured image">
                </div>
                <div class="modal-footer justify-content-between">
                    <div class="btn-group" role="group">
                        <button type="button" id="modalViewProcessed" class="btn btn-outline-primary active"
                            data-src="">Processed</button>
                        <button type="button" id="modalViewOriginal" class="btn btn-outline-primary"
                            data-src="">Original</button>
                    </div>
                    <button type="button" id="modalDownload" class="btn btn-success" data-src="">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        $(document).ready(function () {
            // Initialize Bootstrap modals
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modalEl => {
                new bootstrap.Modal(modalEl);
            });

            // Common variables
            const settings = {
                detection_method: 'vein',
                contrast_method: 'clahe',
                led_brightness: 50,
                led_pattern: 1,
                camera_exposure: 20000,
                camera_gain: 10
            };

            // Load settings initially
            fetch('/get_settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Object.assign(settings, data.settings);

                        // Update UI controls
                        document.getElementById('detectionMethod').value = settings.detection_method;
                        document.getElementById('contrastMethod').value = settings.contrast_method;
                        document.getElementById('ledBrightness').value = settings.led_brightness;
                        document.getElementById('ledPattern').value = settings.led_pattern;
                        document.getElementById('cameraExposure').value = settings.camera_exposure;
                        document.getElementById('cameraGain').value = settings.camera_gain;

                        // Update displayed values
                        document.getElementById('brightnessValue').textContent = settings.led_brightness;
                        document.getElementById('exposureValue').textContent = settings.camera_exposure;
                        document.getElementById('gainValue').textContent = settings.camera_gain;

                        updateCameraInfo();
                    }
                });

            // Initialize range sliders
            const ledBrightness = document.getElementById('ledBrightness');
            const brightnessValue = document.getElementById('brightnessValue');

            ledBrightness.addEventListener('input', function () {
                brightnessValue.textContent = this.value;
            });

            const cameraExposure = document.getElementById('cameraExposure');
            const exposureValue = document.getElementById('exposureValue');

            cameraExposure.addEventListener('input', function () {
                exposureValue.textContent = this.value;
            });

            const cameraGain = document.getElementById('cameraGain');
            const gainValue = document.getElementById('gainValue');

            cameraGain.addEventListener('input', function () {
                gainValue.textContent = this.value;
            });

            // Apply camera settings
            document.getElementById('applyCameraSettings').addEventListener('click', function (e) {
                e.preventDefault();
                const updatedSettings = {
                    camera_exposure: parseInt(cameraExposure.value),
                    camera_gain: parseFloat(cameraGain.value),
                    detection_method: document.getElementById('detectionMethod').value,
                    contrast_method: document.getElementById('contrastMethod').value,
                    stream_resolution: document.getElementById('streamResolution').value
                };

                Object.assign(settings, updatedSettings);

                fetch('/update_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedSettings)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Camera settings updated successfully', 'success');
                            updateCameraInfo();
                        } else {
                            showAlert('Error updating camera settings', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            });

            // Stream resolution selector change event
            document.getElementById('streamResolution').addEventListener('change', function () {
                const newResolution = this.value;

                // Show loading indicator
                const videoStream = document.querySelector('.video-stream');
                videoStream.style.opacity = '0.5';

                fetch('/update_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        stream_resolution: newResolution
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert(`Stream resolution changed to ${newResolution}`, 'success');

                            // Reload the video stream
                            const videoSrc = videoStream.src;
                            videoStream.src = '';
                            setTimeout(() => {
                                videoStream.src = videoSrc + '?t=' + new Date().getTime();
                                videoStream.style.opacity = '1';
                            }, 1000);

                            // Update displayed settings
                            settings.stream_resolution = newResolution;
                        } else {
                            showAlert('Error changing resolution', 'danger');
                            videoStream.style.opacity = '1';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                        videoStream.style.opacity = '1';
                    });
            });

            // Capture image function
            document.getElementById('captureBtn').addEventListener('click', captureImage);

            function captureImage() {
                // Show loading indicator
                const captureBtn = document.getElementById('captureBtn');
                const captureSpinner = document.getElementById('captureSpinner');
                const captureBtnText = document.getElementById('captureBtnText');

                captureBtn.disabled = true;
                captureSpinner.classList.remove('d-none');
                captureBtnText.textContent = 'Processing...';

                fetch('/capture', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_info: {
                            name: document.getElementById('patientName')?.value || 'unknown',
                            age: document.getElementById('patientAge')?.value || '',
                            procedure: document.getElementById('procedureType')?.value || ''
                        },
                        detection_method: settings.detection_method,
                        contrast_method: settings.contrast_method
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Hide loading indicator
                        captureBtn.disabled = false;
                        captureSpinner.classList.add('d-none');
                        captureBtnText.textContent = 'Capture';

                        if (data.success) {
                            showAlert('Image captured successfully', 'success');

                            // Update the last captured image
                            const lastCapturedImg = document.getElementById('lastCapturedImg');
                            lastCapturedImg.src = data.processed_image + '?t=' + new Date().getTime();

                            // Show the last captured image container
                            document.getElementById('lastCapturedContainer').classList.remove('d-none');

                            // Update captured image info
                            const capturedImageInfo = document.getElementById('capturedImageInfo');
                            capturedImageInfo.classList.remove('d-none');

                            // Set timestamp
                            const captureTimestamp = document.getElementById('captureTimestamp');
                            try {
                                const timestamp = data.timestamp;
                                const date = new Date(timestamp.substring(0, 4),
                                    parseInt(timestamp.substring(4, 6)) - 1,
                                    timestamp.substring(6, 8),
                                    timestamp.substring(9, 11),
                                    timestamp.substring(11, 13),
                                    timestamp.substring(13, 15));
                                captureTimestamp.textContent = date.toLocaleString();
                            } catch (e) {
                                captureTimestamp.textContent = data.timestamp || 'Unknown';
                            }

                            // Set view buttons
                            const viewOriginalBtn = document.getElementById('viewOriginalBtn');
                            const viewProcessedBtn = document.getElementById('viewProcessedBtn');
                            const downloadBtn = document.getElementById('downloadBtn');

                            viewOriginalBtn.href = data.original_image;
                            viewProcessedBtn.href = data.processed_image;
                            downloadBtn.href = data.processed_image;
                            downloadBtn.download = data.processed_image.split('/').pop();

                            // Update counter
                            updateCaptureCounter();

                            // Refresh gallery
                            loadImageGallery();
                        } else {
                            showAlert('Error capturing image: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        // Hide loading indicator
                        captureBtn.disabled = false;
                        captureSpinner.classList.add('d-none');
                        captureBtnText.textContent = 'Capture';

                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            }

            // Load image gallery
            function loadImageGallery() {
                const galleryContainer = document.getElementById('imageGallery');

                // Show loading spinner
                galleryContainer.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading saved images...</p>
                    </div>
                `;

                // Add cache-busting parameter to avoid cached responses
                const cacheBuster = new Date().getTime();
                fetch(`/images?_=${cacheBuster}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.images && data.images.length > 0) {
                            console.log(`Found ${data.images.length} images`);
                            let galleryHTML = '';

                            data.images.forEach(image => {
                                const timestamp = image.timestamp;
                                let formattedDate = '';
                                try {
                                    // Parse timestamp format: YYYYMMDD_HHMMSS
                                    const year = timestamp.substring(0, 4);
                                    const month = parseInt(timestamp.substring(4, 6)) - 1; // JS months are 0-based
                                    const day = timestamp.substring(6, 8);
                                    const hour = timestamp.substring(9, 11);
                                    const minute = timestamp.substring(11, 13);
                                    const second = timestamp.substring(13, 15);

                                    const date = new Date(year, month, day, hour, minute, second);
                                    formattedDate = date.toLocaleString();
                                } catch (e) {
                                    console.error("Error parsing date:", e);
                                    formattedDate = timestamp || 'Unknown';
                                }

                                // Add cache-busting parameter to image URLs
                                const processedImage = `${image.processed_image}?t=${cacheBuster}`;
                                const originalImage = `${image.original_image}?t=${cacheBuster}`;

                                galleryHTML += `
                                <div class="col-md-4 col-sm-6 mb-4">
                                    <div class="card image-card h-100">
                                        <div class="position-relative">
                                            <img src="${processedImage}" 
                                                 class="card-img-top gallery-image" 
                                                 alt="Captured Image"
                                                 data-img-src="${image.processed_image}"
                                                 data-orig-src="${image.original_image}"
                                                 data-timestamp="${timestamp}">
                                            <div class="card-overlay">
                                                <small>${formattedDate}</small>
                                            </div>
                                        </div>
                                        <div class="card-footer d-flex justify-content-between">
                                            <button class="btn btn-sm btn-primary view-image-btn" 
                                                    data-processed-src="${image.processed_image}" 
                                                    data-original-src="${image.original_image}" 
                                                    data-timestamp="${timestamp}">
                                                <i class="fas fa-eye me-1"></i>View
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-image-btn" 
                                                    data-image-path="${image.processed_image}">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            });

                            galleryContainer.innerHTML = galleryHTML;

                            // Add event listeners to view buttons
                            document.querySelectorAll('.view-image-btn').forEach(button => {
                                button.addEventListener('click', function () {
                                    const processedSrc = this.getAttribute('data-processed-src');
                                    const originalSrc = this.getAttribute('data-original-src');
                                    const timestamp = this.getAttribute('data-timestamp');

                                    // Set image source in modal with cache-buster
                                    document.getElementById('modalImage').src = processedSrc + '?t=' + new Date().getTime();

                                    // Update toggle buttons
                                    const viewOriginalBtn = document.getElementById('modalViewOriginal');
                                    const viewProcessedBtn = document.getElementById('modalViewProcessed');

                                    viewOriginalBtn.setAttribute('data-src', originalSrc);
                                    viewProcessedBtn.setAttribute('data-src', processedSrc);

                                    // Set active state
                                    viewProcessedBtn.classList.add('active');
                                    viewOriginalBtn.classList.remove('active');

                                    // Set download link
                                    document.getElementById('modalDownload').setAttribute('data-src', processedSrc);

                                    // Show the modal
                                    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                                    imageModal.show();
                                });
                            });

                            // Add event listeners to delete buttons
                            document.querySelectorAll('.delete-image-btn').forEach(button => {
                                button.addEventListener('click', function () {
                                    const imagePath = this.getAttribute('data-image-path');
                                    const imageCard = this.closest('.col-md-4');

                                    if (confirm('Are you sure you want to delete this image?')) {
                                        console.log('Sending delete request for:', imagePath);

                                        fetch('/delete_image', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({ image_path: imagePath })
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.success) {
                                                    // Remove the image card from the gallery
                                                    imageCard.remove();
                                                    showAlert('Image deleted successfully', 'success');
                                                    updateCaptureCounter();

                                                    console.log('Delete response:', data);
                                                } else {
                                                    showAlert('Error deleting image: ' + data.message, 'danger');
                                                    console.error('Delete error:', data.message);
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error during delete request:', error);
                                                showAlert('Error communicating with server', 'danger');
                                            });
                                    }
                                });
                            });

                            // Make gallery images clickable to open modal
                            document.querySelectorAll('.gallery-image').forEach(img => {
                                img.addEventListener('click', function () {
                                    const processedSrc = this.getAttribute('data-img-src');
                                    const originalSrc = this.getAttribute('data-orig-src');
                                    const timestamp = this.getAttribute('data-timestamp');

                                    // Set image source in modal
                                    document.getElementById('modalImage').src = processedSrc + '?t=' + new Date().getTime();

                                    // Update toggle buttons
                                    const viewOriginalBtn = document.getElementById('modalViewOriginal');
                                    const viewProcessedBtn = document.getElementById('modalViewProcessed');

                                    viewOriginalBtn.setAttribute('data-src', originalSrc);
                                    viewProcessedBtn.setAttribute('data-src', processedSrc);

                                    // Set active state
                                    viewProcessedBtn.classList.add('active');
                                    viewOriginalBtn.classList.remove('active');

                                    // Set download link
                                    document.getElementById('modalDownload').setAttribute('data-src', processedSrc);

                                    // Show the modal
                                    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                                    imageModal.show();
                                });
                            });
                        } else {
                            galleryContainer.innerHTML = `
                            <div class="col-12 text-center py-5">
                                <i class="fas fa-images fa-3x mb-3 text-muted"></i>
                                <p>No images captured yet. Use the capture button to save images.</p>
                            </div>
                        `;
                            console.log('No images found or empty response');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading gallery:', error);
                        galleryContainer.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                            <p>Error loading gallery. Please try refreshing.</p>
                            <p class="small text-muted">Error: ${error.message}</p>
                        </div>
                    `;
                    });
            }

            // Handle image view toggles in modal
            document.getElementById('modalViewOriginal').addEventListener('click', function () {
                const src = this.getAttribute('data-src');
                document.getElementById('modalImage').src = src + '?t=' + new Date().getTime();

                // Update active state
                this.classList.add('active');
                document.getElementById('modalViewProcessed').classList.remove('active');

                // Update download link
                document.getElementById('modalDownload').setAttribute('data-src', src);
            });

            document.getElementById('modalViewProcessed').addEventListener('click', function () {
                const src = this.getAttribute('data-src');
                document.getElementById('modalImage').src = src + '?t=' + new Date().getTime();

                // Update active state
                this.classList.add('active');
                document.getElementById('modalViewOriginal').classList.remove('active');

                // Update download link
                document.getElementById('modalDownload').setAttribute('data-src', src);
            });

            // Handle download button in modal
            document.getElementById('modalDownload').addEventListener('click', function (e) {
                e.preventDefault();
                const imgSrc = this.getAttribute('data-src');

                // Create a temporary link and trigger download
                const link = document.createElement('a');
                link.href = imgSrc;
                link.download = imgSrc.split('/').pop();
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // Show alert function
            function showAlert(message, type) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;

                document.querySelector('.container').prepend(alertDiv);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    // Bootstrap 5 way of removing the alert
                    alertDiv.classList.remove('show');
                    setTimeout(() => {
                        alertDiv.remove();
                    }, 150); // Wait for fade out animation
                }, 5000);
            }

            // Update camera info based on settings
            function updateCameraInfo() {
                fetch('/camera_info')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update exposure and gain info in the camera-info div
                            document.getElementById('exposureInfo').textContent = `Exp: ${data.camera_info.exposure}μs`;
                            document.getElementById('gainInfo').textContent = `Gain: ${data.camera_info.gain}`;

                            // Update detection method display
                            document.getElementById('detectionMethodDisplay').textContent = settings.detection_method;
                        }
                    });
            }

            // Hardware status monitoring
            function updateHardwareStatus() {
                fetch('/hardware_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update camera status
                            const cameraStatus = data.camera;
                            const systemStatus = document.getElementById('systemStatus');
                            const ledStatus = document.getElementById('ledStatus');

                            if (cameraStatus.connected) {
                                if (cameraStatus.simulation) {
                                    systemStatus.textContent = 'Simulation Mode';
                                    systemStatus.classList.add('text-warning');
                                } else {
                                    systemStatus.textContent = 'Online';
                                    systemStatus.classList.remove('text-warning');
                                }
                            } else {
                                systemStatus.textContent = 'Camera Offline';
                                systemStatus.classList.add('text-danger');
                            }

                            // Update LED status
                            if (data.led_controller.connected) {
                                ledStatus.textContent = 'Connected';
                                ledStatus.classList.remove('text-danger');
                            } else {
                                ledStatus.textContent = 'Disconnected';
                                ledStatus.classList.add('text-danger');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking hardware status:', error);
                        // If we can't connect, update the status
                        const systemStatus = document.getElementById('systemStatus');
                        systemStatus.textContent = 'Connection Error';
                        systemStatus.classList.add('text-danger');
                    });
            }

            // Check hardware status initially and then every 10 seconds
            updateHardwareStatus();
            setInterval(updateHardwareStatus, 10000);

            // Update capture counter
            function updateCaptureCounter() {
                fetch('/image_count')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('captureCounter').textContent = data.count;
                        }
                    });
            }

            // Toggle LEDs
            document.getElementById('toggleLEDs').addEventListener('click', function () {
                fetch('/toggle_leds', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const ledStatus = document.getElementById('ledStatus');
                            ledStatus.textContent = data.led_status ? 'Active' : 'Inactive';
                            showAlert(`LEDs ${data.led_status ? 'activated' : 'deactivated'} successfully`, 'success');
                        } else {
                            showAlert('Error toggling LEDs', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            });

            // Apply LED settings
            document.getElementById('applyLEDSettings').addEventListener('click', function () {
                const updatedSettings = {
                    led_brightness: parseInt(document.getElementById('ledBrightness').value),
                    led_pattern: parseInt(document.getElementById('ledPattern').value)
                };

                Object.assign(settings, updatedSettings);

                fetch('/update_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedSettings)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('LED settings updated successfully', 'success');
                        } else {
                            showAlert('Error updating LED settings', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            });

            // Clear gallery
            document.getElementById('clearGalleryBtn').addEventListener('click', function () {
                if (confirm('Are you sure you want to clear all saved images? This cannot be undone.')) {
                    fetch('/clear_gallery', {
                        method: 'POST'
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showAlert('Gallery cleared successfully', 'success');
                                loadImageGallery();
                            } else {
                                showAlert('Error clearing gallery', 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showAlert('Error communicating with server', 'danger');
                        });
                }
            });

            // Refresh gallery
            document.getElementById('refreshGalleryBtn').addEventListener('click', function () {
                loadImageGallery();
                showAlert('Gallery refreshed', 'info');
            });

            // Save patient form
            document.getElementById('patientForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const patientData = {
                    name: document.getElementById('patientName').value,
                    age: document.getElementById('patientAge').value,
                    procedure: document.getElementById('procedureType').value
                };

                fetch('/save_patient', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patientData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Patient information saved successfully', 'success');
                        } else {
                            showAlert('Error saving patient information', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            });

            // Save notes
            document.getElementById('saveNotesBtn').addEventListener('click', function () {
                const notes = document.getElementById('procedureNotes').value;

                fetch('/save_notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notes: notes })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Notes saved successfully', 'success');
                        } else {
                            showAlert('Error saving notes', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            });

            // Clear notes
            document.getElementById('clearNotesBtn').addEventListener('click', function () {
                document.getElementById('procedureNotes').value = '';
                showAlert('Notes cleared', 'info');
            });

            // Handle zoom in/out
            document.getElementById('zoomInBtn').addEventListener('click', function () {
                fetch('/zoom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'in' })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Zoomed in', 'info');
                        }
                    });
            });

            document.getElementById('zoomOutBtn').addEventListener('click', function () {
                fetch('/zoom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'out' })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Zoomed out', 'info');
                        }
                    });
            });

            // Rotate image
            document.getElementById('rotateBtn').addEventListener('click', function () {
                fetch('/rotate', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Image rotated', 'info');
                        }
                    });
            });

            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', function () {
                document.body.classList.toggle('dark-mode');

                if (document.body.classList.contains('dark-mode')) {
                    this.innerHTML = '<i class="fas fa-sun me-2"></i>Light Mode';
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    this.innerHTML = '<i class="fas fa-moon me-2"></i>Dark Mode';
                    localStorage.setItem('darkMode', 'disabled');
                }
            });

            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').innerHTML = '<i class="fas fa-sun me-2"></i>Light Mode';
            }

            // Handle fullscreen
            document.getElementById('fullscreenBtn').addEventListener('click', function () {
                const videoContainer = document.querySelector('.video-container');

                if (!document.fullscreenElement) {
                    if (videoContainer.requestFullscreen) {
                        videoContainer.requestFullscreen();
                    } else if (videoContainer.webkitRequestFullscreen) {
                        videoContainer.webkitRequestFullscreen();
                    } else if (videoContainer.msRequestFullscreen) {
                        videoContainer.msRequestFullscreen();
                    }
                    this.innerHTML = '<i class="fas fa-compress"></i>';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                    this.innerHTML = '<i class="fas fa-expand"></i>';
                }
            });

            // Event listener for fullscreen change
            document.addEventListener('fullscreenchange', function () {
                const fullscreenBtn = document.getElementById('fullscreenBtn');
                if (!document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                } else {
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                }
            });

            // Handle system shutdown
            document.getElementById('confirmShutdown').addEventListener('click', function () {
                fetch('/shutdown', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('System is shutting down...', 'warning');
                            // Close the modal
                            const shutdownModal = bootstrap.Modal.getInstance(document.getElementById('shutdownModal'));
                            shutdownModal.hide();
                            // Show a full page message
                            document.body.innerHTML = `
                            <div class="d-flex justify-content-center align-items-center vh-100">
                                <div class="text-center">
                                    <i class="fas fa-power-off fa-5x text-danger mb-4"></i>
                                    <h1>System Shutting Down</h1>
                                    <p class="lead">The Raspberry Pi is now shutting down safely.</p>
                                    <p>Please wait until the system is fully powered off before disconnecting power.</p>
                                    <div class="spinner-border text-primary mt-4" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        } else {
                            showAlert('Error shutting down system: ' + data.message, 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error communicating with server', 'danger');
                    });
            });

            // Load gallery and update camera info on page load
            loadImageGallery();
            updateCameraInfo();
            updateCaptureCounter();
        });
    </script>
</body>

</html>